syntax = "proto3";

package booking.v1;

option go_package = "github.com/wylu1037/go-micro-boilerplate/gen/go/booking/v1;bookingv1";

import "common/v1/pagination.proto";

// Booking service handles orders and payments
service BookingService {
  // Order management
  rpc CreateOrder(CreateOrderRequest) returns (Order);
  rpc GetOrder(GetOrderRequest) returns (Order);
  rpc ListUserOrders(ListUserOrdersRequest) returns (ListOrdersResponse);
  rpc CancelOrder(CancelOrderRequest) returns (Order);

  // Payment
  rpc InitiatePayment(InitiatePaymentRequest) returns (InitiatePaymentResponse);
  rpc HandlePaymentCallback(PaymentCallbackRequest) returns (PaymentCallbackResponse);
  rpc GetPaymentStatus(GetPaymentStatusRequest) returns (PaymentStatus);

  // Seat reservation (Redis-backed)
  rpc ReserveSeats(ReserveSeatsRequest) returns (ReserveSeatsResponse);
  rpc ReleaseReservation(ReleaseReservationRequest) returns (ReleaseReservationResponse);
}

// Order represents a ticket purchase
message Order {
  string order_id = 1;
  string user_id = 2;
  string session_id = 3;
  string show_title = 4;
  OrderStatus status = 5;
  repeated OrderItem items = 6;
  int64 total_amount_cents = 7;
  PaymentInfo payment = 8;
  common.v1.Timestamp created_at = 9;
  common.v1.Timestamp updated_at = 10;
  common.v1.Timestamp expires_at = 11;  // For pending orders
}

enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0;
  ORDER_STATUS_PENDING = 1;      // Created, awaiting payment
  ORDER_STATUS_PAYING = 2;       // Payment in progress
  ORDER_STATUS_PAID = 3;         // Payment successful
  ORDER_STATUS_CANCELLED = 4;    // Cancelled by user or timeout
  ORDER_STATUS_REFUNDED = 5;     // Refund completed
  ORDER_STATUS_FAILED = 6;       // Payment failed
}

message OrderItem {
  string order_item_id = 1;
  string seat_area_id = 2;
  string seat_area_name = 3;
  int32 quantity = 4;
  int64 unit_price_cents = 5;
  int64 subtotal_cents = 6;
}

message PaymentInfo {
  string payment_id = 1;
  PaymentMethod method = 2;
  PaymentStatus status = 3;
  string transaction_id = 4;  // Third-party payment ID
  common.v1.Timestamp paid_at = 5;
}

enum PaymentMethod {
  PAYMENT_METHOD_UNSPECIFIED = 0;
  PAYMENT_METHOD_ALIPAY = 1;
  PAYMENT_METHOD_WECHAT = 2;
  PAYMENT_METHOD_CREDIT_CARD = 3;
}

message PaymentStatus {
  string payment_id = 1;
  string order_id = 2;
  PaymentStatusCode status = 3;
  string message = 4;
}

enum PaymentStatusCode {
  PAYMENT_STATUS_CODE_UNSPECIFIED = 0;
  PAYMENT_STATUS_CODE_PENDING = 1;
  PAYMENT_STATUS_CODE_PROCESSING = 2;
  PAYMENT_STATUS_CODE_SUCCESS = 3;
  PAYMENT_STATUS_CODE_FAILED = 4;
  PAYMENT_STATUS_CODE_REFUNDED = 5;
}

// Order creation
message CreateOrderRequest {
  string user_id = 1;
  string session_id = 2;
  repeated OrderItemRequest items = 3;
  string reservation_id = 4;  // From ReserveSeats
}

message OrderItemRequest {
  string seat_area_id = 1;
  int32 quantity = 2;
}

message GetOrderRequest {
  string order_id = 1;
}

message ListUserOrdersRequest {
  string user_id = 1;
  common.v1.PaginationRequest pagination = 2;
  OrderStatus status = 3;  // Optional filter
}

message ListOrdersResponse {
  repeated Order orders = 1;
  common.v1.PaginationResponse pagination = 2;
}

message CancelOrderRequest {
  string order_id = 1;
  string reason = 2;
}

// Payment
message InitiatePaymentRequest {
  string order_id = 1;
  PaymentMethod method = 2;
  string return_url = 3;  // Redirect after payment
}

message InitiatePaymentResponse {
  string payment_id = 1;
  string payment_url = 2;  // Redirect to this URL for payment
  string qr_code_url = 3;  // For scan-to-pay
  int64 expires_in = 4;    // Payment link expiry in seconds
}

message PaymentCallbackRequest {
  string payment_id = 1;
  string transaction_id = 2;
  PaymentStatusCode status = 3;
  string raw_payload = 4;  // Original callback data for verification
}

message PaymentCallbackResponse {
  bool success = 1;
  string message = 2;
}

message GetPaymentStatusRequest {
  string payment_id = 1;
}

// Seat reservation
message ReserveSeatsRequest {
  string user_id = 1;
  string session_id = 2;
  repeated SeatReservation seats = 3;
}

message SeatReservation {
  string seat_area_id = 1;
  int32 quantity = 2;
}

message ReserveSeatsResponse {
  bool success = 1;
  string reservation_id = 2;
  int64 expires_in = 3;  // Reservation expiry in seconds (e.g., 900 for 15 min)
  string error_message = 4;
}

message ReleaseReservationRequest {
  string reservation_id = 1;
}

message ReleaseReservationResponse {
  bool success = 1;
}
