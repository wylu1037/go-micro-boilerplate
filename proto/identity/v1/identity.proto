syntax = "proto3";

package identity.v1;

option go_package = "github.com/wylu1037/go-micro-boilerplate/gen/go/identity/v1;identityv1";

import "common/v1/pagination.proto";
import "buf/validate/validate.proto";
import "google/api/annotations.proto";

// Identity service handles user authentication and profile management
service IdentityService {
  // Register a new user account
  rpc Register(RegisterRequest) returns (RegisterResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/register"
      body: "*"
    };
  }

  // Login with credentials and get access token
  rpc Login(LoginRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/login"
      body: "*"
    };
  }

  // Refresh access token using refresh token
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/refresh"
      body: "*"
    };
  }

  // Get current user's profile
  rpc GetProfile(GetProfileRequest) returns (GetProfileResponse) {
    option (google.api.http) = {
      get: "/api/v1/users/{user_id}"
    };
  }

  // Update user profile
  rpc UpdateProfile(UpdateProfileRequest) returns (UpdateProfileResponse) {
    option (google.api.http) = {
      put: "/api/v1/users/{user_id}"
      body: "*"
    };
  }

  // Request password reset
  rpc RequestPasswordReset(RequestPasswordResetRequest) returns (RequestPasswordResetResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/password/reset-request"
      body: "*"
    };
  }

  // Reset password with token
  rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/password/reset"
      body: "*"
    };
  }

  // Validate access token (for internal service use)
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse) {
    option (google.api.http) = {
      post: "/api/v1/auth/validate"
      body: "*"
    };
  }
}

// User registration
message RegisterRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  string password = 2 [(buf.validate.field).string.min_len = 6];
  string name = 3 [(buf.validate.field).string.min_len = 1];
  string phone = 4;
}

message RegisterResponse {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  string message = 2;
}

// User login
message LoginRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  string password = 2 [(buf.validate.field).required = true];
}

message LoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;  // Access token expiry in seconds
  UserProfile user = 4;
}

// Token refresh
message RefreshTokenRequest {
  string refresh_token = 1 [(buf.validate.field).string.min_len = 1];
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
}

// User profile
message GetProfileRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
}

message UpdateProfileRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2;
  string phone = 3;
  string avatar_url = 4;
}

message GetProfileResponse {
  UserProfile user = 1;
}

message UpdateProfileResponse {
  UserProfile user = 1;
}

message UserProfile {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  string email = 2;
  string name = 3;
  string phone = 4;
  string avatar_url = 5;
  common.v1.Timestamp created_at = 6;
  common.v1.Timestamp updated_at = 7;
}

// Password reset
message RequestPasswordResetRequest {
  string email = 1 [(buf.validate.field).string.email = true];
}

message RequestPasswordResetResponse {
  string message = 1;
}

message ResetPasswordRequest {
  string token = 1 [(buf.validate.field).string.min_len = 1];
  string new_password = 2 [(buf.validate.field).string.min_len = 6];
}

message ResetPasswordResponse {
  string message = 1;
}

// Token validation (internal)
message ValidateTokenRequest {
  string access_token = 1 [(buf.validate.field).string.min_len = 1];
}

message ValidateTokenResponse {
  bool valid = 1;
  string user_id = 2 [(buf.validate.field).string.uuid = true];
  string email = 3;
}
